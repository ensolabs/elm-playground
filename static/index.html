<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LÃ¦r Elm med Enso</title>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        display: flex;
        height: 100vh;
      }

      textarea {
        width: 50%;
        height: 100%;
        border: none;
        padding: 1rem;
        resize: none;
        font-family: monospace;
        font-size: 14px;
        box-sizing: border-box;
        border-right: 1px solid #ccc;
      }

      iframe {
        width: 50%;
        height: 100%;
        border: none;
      }
    </style>
  </head>
  <body>
    <textarea id="elmInput"></textarea>
    <iframe id="preview"></iframe>

    <script>
      const textarea = document.getElementById("elmInput");
      const iframe = document.getElementById("preview");
      let timeout = null;

      async function loadExample() {
        const hash = window.location.hash.slice(1) || "1"; // Default to '1' if no hash
        try {
          const response = await fetch(`/example/${hash}`);
          if (!response.ok) {
            throw new Error(`Failed to load example: ${response.statusText}`);
          }
          const exampleCode = await response.text();
          textarea.value = exampleCode;
          compileAndRender();
        } catch (err) {
          console.error("Failed to load example:", err);
          // Fallback to default example if loading fails
          textarea.value = `module Main exposing (main)

import Browser
import Html exposing (text)

main =
    Browser.sandbox
        { init = ()
        , view = \\_ -> text "Hello, Elm!"
        , update = \\_ model -> model
        }`;
          compileAndRender();
        }
      }

      async function compileAndRender() {
        try {
          const response = await fetch("/compile", {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: textarea.value,
          });

          const jsCode = await response.text();

          if (!response.ok) {
            iframe.srcdoc = `<pre style="color: red; padding: 1rem;">${jsCode}</pre>`;
            return;
          }

          iframe.srcdoc = `<!DOCTYPE html><html><head><meta charset='utf-8'></head><body><div id="elm"></div><script>${jsCode}\nElm.Main.init({ node: document.getElementById('elm') })<\/script></body></html>`;
        } catch (err) {
          iframe.srcdoc = `<pre style="color: red; padding: 1rem;">Request failed:\n${err}</pre>`;
        }
      }

      // Listen for hash changes
      window.addEventListener("hashchange", loadExample);

      textarea.addEventListener("input", () => {
        clearTimeout(timeout);
        timeout = setTimeout(compileAndRender, 500);
      });

      // Load example and initial render
      loadExample();
    </script>
  </body>
</html>
